# Модуль settings
## Класс Settings

В данном модуле задаются настройки программы. Для каждого свойства предоставляется полное и подробное описание на русском языке, объясняющее, как и на что влияет эта настройка.

Для составления списка настроек необходимо использовать описание проекта, найти все упоминания настроек, проанализировать их и составить подробное описание каждой настройки и способ ее использования.

Функция генерации идентификатора возвращает уникальный элемент с использованием `time.time()`.

# Модуль ml_model
## Класс Model

Создает машинную модель для эмбеддинга изображений.
Объект model создается в модуле и импортируется в других.

### Инициализация:
- `model` — создается модель.

### Методы:
- `get_embedding` — выполняет эмбеддинг, возвращает список векторов.

# Модуль chroma_db
## Класс Chroma

При импорте создается объект класса, который используется для работы с базой данных в различных частях программы.

### Инициализация:
- Создает сервер ChromaDB на порту 8000.

### Методы:
- `shutdown` - остановка сервера БД
- `get_screen_id` — получает вектор, проверяет, есть ли близкий в базе данных (степень близости для экрана задается в настройках `settings`), возвращает `screen_id` или `None`.
- `create_screen` — получает `screen_id` и вектор, создает документ с ними. Также принимает метаданные в виде словаря, но если они пустые, не сохраняет их.
- `get_sample_id` — получает вектор и `screen_id` в метаданных (словарь), проверяет, есть ли близкий в базе данных (степень близости для образца задается в настройках `settings`), возвращает `sample_id` или `None`.
- `create_sample` — получает `sample_id`, вектор и `screen_id` в метаданных (словарь), создает документ с этими данными.
- `get_sample` — по идентификатору и метаданным возвращает все поля документа или `None`.

# Модуль screen_monitor
## Класс ScreenMonitor

Класс периодически создает снимки экрана и определяет, отличается ли текущий снимок от предыдущего. При отличии снимок записывается в общую память.

### Методы:
- `_monitor_screen_process` — работает в отдельном процессе. Делает снимок экрана с периодичностью, заданной в настройках (`settings`), сравнивает его хэш с предыдущим. При значительном различии (заданном в `settings`) записывает снимок в общую память `shared_memory`.
- `start` — запускает процесс мониторинга.
- `stop` — останавливает процесс мониторинга.
- `get_screenshot` — возвращает снимок экрана из `shared_memory` в формате numpy.
- `clear_shared_memory` — очищает данные в `shared_memory`, не удаляя саму область памяти.

# Модуль manager
## Класс Manager

Создает ресурсы для процессов записи и воспроизведения. 
После создания вызывается start() в try и stop() в finally.

### Инициализация:
- `screen_id` — идентификатор экрана.
- `screenshot` — изображение экрана в формате numpy.
- `monitor` — объект класса `ScreenMonitor` из модуля `screen_monitor`.

### Методы:
- `start`:
  - Вызывает метод `start()` объекта `monitor`, запуская отслеживание экрана.
- `stop`:
  - Вызывает метод `stop()` объекта `monitor`, останавливая отслеживание экрана.
  - вызывает метод `shutdown()` класса `Chroma`


# Модуль input_tracker
## Класс InputTracker

Модуль предназначен для отслеживания и регистрации событий ввода пользователя, включая нажатия клавиш, клики мыши и прокрутку колесика мыши с помощью pynput.

1. Отслеживание кликов мыши (левой, правой и средней кнопками)
2. Отслеживание двойного клика мыши
3. Отслеживание прокрутки колесика мыши
4. Отслеживание нажатий клавиш клавиатуры
5. Обработка комбинаций клавиш (начинаются с нажатия второй клавиши, 
   завершаются при отпускании любой из задействованных клавиш)
6. Нажатие и отпускание клавиш мыши или клавиатуры записывается как одно целое.
7. Выход из режима отслеживания осуществляется двойным нажатием клавиши ESC
8. Клавиатура всегда возвращает символы, не коды клавиш

Методы (не окончательный список, можно дополнить)
- `start` - Создаем и настраиваем слушатель клавиатуры, слушатель мыши. Запускаем слушатели. Цикл будет работать, пока не изменится self.exit_flag который изменяется двойным нажатием esc. Возвращает список команд.
- `stop` - Останавливает отслеживание и освобождает ресурсы. 
- `on_key_press` - Обработчик события нажатия клавиши. Обновляется текущий экран с помощью функции `screen_update` модуля `images`.
- `on_key_release` - Обработчик события отпускания клавиши.
- `on_mouse_click` -  Обработчик событий мыши (клики). Обновляется текущий экран с помощью функции `screen_update` модуля `images`.
- `on_mouse_scroll` - Обработчик событий прокрутки колеса мыши. Обновляется текущий экран с помощью функции `screen_update` модуля `images`.
- `get_key_name` - Преобразует объект клавиши в строковое представление.
        Обрабатывает различные типы клавиш, включая специальные клавиши, 
        управляющие символы, клавиши в комбинациях Ctrl+Alt. Унифицирует
        представление модификаторов (левый и правый Ctrl отображаются 
        одинаково) и преобразует коды клавиш в понятные имена.

Для функций, обрабатывающих события мыши, дополнительно записываются области экрана, где находился указатель в момент события, с помощью функции `set_sample` модуля `images`. Полученный `sample_id` используется при формировании названия события.

Какжый клик мыши, двойной клик, нажатие и отпускание клавиши клавиатуры, скролл, комбинация клавиш записываются как команда (раздел Команды Для плейера). Возвращается их список.
Модуль должен иметь вход для запуска из терминала. Он должен принимать события и выводить их в терминал. 
При таком тестировании должна быть возможность отключить внешние модули и подключить их.

# Модуль images
## Функции

Принимают объект manager, остальные зависимости импортируют из их модулей.

- `screen_update` — обновляет текущий экран программы, который используется для поиска элементов при записи и получения его `screen_id`.
  - Вызывает метод `get_screenshot` объекта `screen_monitor`, получает изображение в формате numpy (если оно доступно). Если изображения нет, возвращает текущий `screen_id` из свойства `screen_id` объекта `Manager`.
  - Сохраняет изображение в свойство `screenshot` объекта `Manager`.
  - Получает область верхнего левого угла размером 64x64 (область и ее расположение задаются в `settings`).
  - Получает вектор выбранного участка с помощью метода `get_embedding` объекта `Model`.
  - Находит `screen_id` экрана по вектору с помощью метода `get_screen_id` объекта `Chroma`.
  - Если `screen_id` не найден, создает новый, передавая идентификатор (генерируется с помощью функции в `settings`) и вектор методу `create_screen` объекта `Chroma`.
  - Сохраняет полный скриншот в папке `screenshots` (имя папки задается в `settings`) с именем `screen_id`.
  - Сохраняет `screen_id` в свойство `screen_id` объекта `Manager` и возвращает его.
- `set_sample` — сохраняет область экрана, в которой произошло событие мыши, и получает ее идентификатор.
  - Получает координаты указателя мыши, принимает их за центр прямоугольника размером 64x64 (размер задается в `settings`).
  - Извлекает сегмент изображения из свойства `screenshot` объекта `Manager`.
  - Получает вектор выбранного участка с помощью метода `get_embedding` объекта `Model`.
  - Находит `sample_id` по вектору и `screen_id` в метаданных (словарь, берется из свойства `screen_id` объекта `Manager`) с помощью метода `get_sample_id` объекта `Chroma`.
  - Если `sample_id` не найден, создает новый, передавая `sample_id` (генерируется с помощью функции в `settings`), `screen_id` в метаданных (словарь) и вектор методу `create_sample` объекта `Chroma`.
  - Сохраняет образец в папке `sample` (имя папки задается в `settings`) с именем `sample_id.png`.
  - Возвращает `sample_id`.
- `get_xy` — получает `sample_id` и вектор, возвращает координаты на экране, где находится изображение.
  - Находит изображение в папке `sample` (имя папки задается в `settings`) по имени `sample_id.png`.
  - С помощью OpenCV находит похожие изображения на скриншоте, хранящемся в свойстве `screenshot` объекта `Manager`. Допуск задается в `settings`. Если изображение не найдено, возвращается ошибка.
  - Получает векторы найденных изображений с помощью метода `get_embedding` класса `Model` и сравнивает их с полученным вектором (косинусное расстояние с использованием numpy).
  - Определяет координаты ближайшего изображения на общем скриншоте.
  - Рассчитывает координаты центра изображения, используя смещение для прямоугольника размером 64x64 (размер задается в `settings`).
  - Возвращает координаты `x, y`.

# Модуль player
## Класс Player

Воспроизводит действия пользователя по одной команде или списком.

### Методы:
- `play_one` — воспроизводит одну команду. Команды разделяются на два блока: `mouse` и `kbd`. Параметры команды разделены символом `_`, по первому слову определяется блок.
  - Перед выполнением любой команды обновляется текущий экран с помощью функции `screen_update` модуля `images`.
  - Получает документ команды из базы данных по `sample_id` (последнее слово в команде). Если возвращается `None`, команда не зарегистрирована, возвращается ошибка.
  - Сравнивает `screen_id` из метаданных документа с `screen_id` объекта `Manager`. Если они не совпадают, возвращается ошибка, указывающая, что система находится не на нужном экране.
  - **Блок `kbd`:**
    - Выполняет действия на клавиатуре.
  - **Блок `mouse`:**
    - Для клика мыши определяет координаты, передавая `sample_id` и вектор в функцию `get_xy`модуля images.

- play_all — выполняет список команд, переданный в виде list. Каждая команда выполняется последовательно, и при возникновении ошибки выводится сообщение об ошибке.

Описание команд в разделе Команды этого документа.

# Модуль main
## Функции

Содержит функции для запуска сервисов пакета. Модуль может использоваться двумя способами:
1. При запуске из внешней программы (как библиотека) - управление жизненным циклом Manager осуществляется вручную.
2. При запуске из командной строки - автоматическое управление жизненным циклом Manager.

### Функции:
- `run` - приниет команды, парсит (первое слово это исполнитель kbd, mouse или действие record, play)
и передает на выполнение нужному исполнителю
- `play` - без параметров из временного файла (настройка в settings.py), с параметрами (имя файла) — читает команды из указанного файла (добавляя расширение json). Вызывает метод `play_all` объекта `Player` модуля `player`, передавая ему список команд.
- `record` — создает объект класса InputTracker модуля input_tracker, принимает список команд и сохраняет его в файл. Если без параметров во временный файл (настройка в settings.py), с параметром — в указанный `.json` файл (список в формате json).
- `kbd...` — передается в метод `play_one` объекта `Player` модуля `player`.
- `mouse...` — передается в метод `play_one` объекта `Player` модуля `player`.

- `cli_main` — точка входа для запуска из командной строки. Осуществляет:
  - Запуск и остановку `Manager` с использованием конструкции `try-finally`
  - Вызов функции `run`
  
### Примеры использования:

#### Как библиотека (внешнее управление жизненным циклом):
```python
from my_app import manager, main

try:
    manager.start()
    main.play("my_script")  # или другие функции
finally:
    manager.stop()
```

#### Из командной строки (автоматическое управление жизненным циклом):
main play или main play 

При вызове из командной строки управление автоматически передается функции `cli_main`, которая обеспечивает корректный запуск и остановку ресурсов.

# Команды
## Для плейера одинаковые из командной строки или с внешней программы:
- `kbd_click_(keys)_event_id` — нажать и отпустить клавишу (в скобках указывается клавиша без кавычек).
- `kbd_combo_(keys)_event_id` — сочетание клавиш (в скобках список клавиш без кавычек, через пробел).
- `mouse_click_left/right_event_id` — клик левой или правой клавишей мыши.
- `mouse_dblclick_left_event_id` — двойной клик левой клавишей мыши.
- `mouse_scroll_x,y_event_id` — прокрутка колесика мыши (x, y — дельта).

## Специальные:
- `play_name` — воспроизвести скрипт с именем `name` или если без имени то по умолчанию (имя в settings).
- `record_name` — записывает скрипт и сохраняет в файл с именем `name` или если без имени то по умолчанию (имя в settings).

`event_id` — уникальный идентификатор.

# Формат записей в базе данных
## screen:
- `ids` — идентификатор экрана.
- `embeddings` — вектор части изображения экрана.

## sample:
- `ids` — идентификатор экрана.
- `embeddings` — вектор части изображения экрана.
- `metadatas` — словарь `{'screen_id': screen_id}`.

# Ошибки и исключения
## Ошибки и исключения
### Ошибки базы данных:
- `ChromaDBError` - ошибка при работе с ChromaDB (недоступность сервера, проблемы с подключением)
- `CollectionNotFoundError` - коллекция не найдена
- `DocumentNotFoundError` - документ не найден
- `DuplicateIDError` - попытка добавить документ с существующим ID

### Ошибки воспроизведения:
- `ScreenMismatchError` - несоответствие текущего экрана требуемому
- `CommandNotFoundError` - команда не найдена в базе данных
- `InvalidCommandError` - некорректный формат команды
- `PlaybackError` - общая ошибка при воспроизведении

### Ошибки мониторинга:
- `ScreenCaptureError` - ошибка при захвате экрана
- `MemoryError` - ошибка работы с shared memory
- `MonitorError` - общая ошибка мониторинга

### Ошибки модели:
- `ModelError` - ошибка при работе с ML моделью
- `EmbeddingError` - ошибка при генерации эмбеддингов

### Ошибки настроек:
- `SettingsError` - ошибка при загрузке/применении настроек
- `InvalidParameterError` - некорректное значение параметра

### Ошибки ввода:
- `InputError` - общая ошибка при обработке ввода
- `MouseError` - ошибка при работе с мышью
- `KeyboardError` - ошибка при работе с клавиатурой
